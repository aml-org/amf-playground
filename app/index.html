<!DOCTYPE html>
<html lang="en">
<head>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta http-equiv="Content-Type" content="text/html;charset=utf-8" >

    <!-- polyfills -->
    <script src="bower_components/webcomponentsjs/webcomponents-lite.min.js"></script>

    <script src="js/preload.js"></script>

    <!-- <script src="./js/amf.js"></script> -->
    <!-- <script src="./js/api_modeller.js"></script> -->

    <!-- Loading Monaco -->
    <!-- <script src="bower_components/monaco-editor/release/min/vs/loader.js"></script> -->
    <!-- Insert this line above script imports  -->
    <!--<script type='text/javascript' src="bower_components/jquery/dist/jquery.min.js"></script>-->
    <!--<script type='text/javascript' src="bower_components/lodash/lodash.min.js"></script>-->
    <!--<script type='text/javascript' src="bower_components/backbone/backbone-min.js"></script>-->
    <!--<script type='text/javascript' src="bower_components/graphlib/dist/graphlib.core.min.js"></script>-->
    <!--<script type='text/javascript' src="bower_components/dagre/dist/dagre.core.js"></script>-->
    <!--<script type='text/javascript' src="bower_components/jointjs/dist/joint.js"></script>-->

    <link rel="stylesheet" href="bower_components/bulma/css/bulma.css">
    <link rel="stylesheet" href="css/app.css">
    <link rel="stylesheet" href="bower_components/font-awesome/css/font-awesome.min.css">
    <link rel="stylesheet" href="bower_components/balloon-css/balloon.css">
    <link rel="stylesheet" href="bower_components/jointjs/dist/joint.css">
    <meta charset="UTF-8">
    <title>API Modeller</title>
</head>
<body>
<!-- Loader view -->
<div id="preloader" class="container is-marginless is-fluid" style="width: 100%; height: 100%; text-align: center; padding-top: 13%">
    <h2 class="title is-2">Loading API Modeller</h2>
    <progress id="preloader-progress" class="progress is-primary" value="0" max="100" style="margin-left: 25%; max-width: 50%; margin-bottom: 1000px">0%</progress>
</div>

<!-- Load spec modal window -->
<link rel="import" href="nav/load_modal.html">
<!-- Main container class -->
<link rel="import" href="nav.html">
<div class="section" style="padding: 0px">
    <div id="the-app" class="container is-marginless is-fluid">
        <div class="columns">
            <div class="column">
                <link rel="import" href="navigator.html">
            </div>
            <div class="column is-three-quarters">
                <link rel="import" href="editor.html">
            </div>
        </div>
        <!-- data-bind="visible: (lastLoadedFile() != null)" -->
        <div data-bind="visible: (lastLoadedFile() != null)"
             style="position: absolute; width: 100%; padding: 10px; bottom: -20px">
            <i class="fa fa-cog fa-spin fa-3x fa-fw"
               data-bind="visible: (lastLoadedFile() != null)"
               style="float:left; font-size: 22px; margin-right: 10px">
            </i>
            <p data-bind="text: ('Loading ' + lastLoadedFile())"></p>
        </div>
    </div>
</div>

<script>
    (function() {
        window.global = window;
        var loadApp = function(cb) {
            var assets = [
                "./js/amf.js",
                "./js/api_modeller.js",
                "bower_components/monaco-editor/release/min/vs/loader.js"
            ];
            var loaded = 0;
            var preload = new createjs.LoadQueue();
            var handleFileComplete = function(event) {
                var oldValue = document.getElementById("preloader-progress").value;
                var newValue = Math.floor(oldValue + (100 / (loaded + assets.length)));
                document.getElementById("preloader-progress").value = newValue;
                document.body.appendChild(event.result);
                loaded++;
                if(assets.length == 0) {
                    document.getElementById("preloader-progress").value = 100;
                    cb();
                } else {
                    console.log("loading " + assets[0]);
                    preload.loadFile(assets.shift());
                }
            };
            preload.addEventListener("fileload", handleFileComplete);
            console.log("loading " + assets[0]);
            preload.loadFile(assets.shift());
        };

        window.addEventListener('WebComponentsReady', function() {
            document.getElementsByName("body");
            // Imported content
            window.reloadApp = function () {
                var importedMap = {};
                var pending = true;
                while (pending === true) {
                    pending = false;
                    var links = document.querySelectorAll('link[rel="import"]');
                    for (var i = 0; i < links.length; i++) {
                        var link = links[i];
                        if (link.import != null && importedMap[link.href] == null) {
                            pending = true;
                            importedMap[link.href] = true;
                            var content = link.import;
                            var el = content.querySelector('.imported');
                            link.parentNode.insertBefore(el.cloneNode(true), link);
                        }
                    }
                }

                require.config({paths: {'vs': 'bower_components/monaco-editor/release/min/vs'}});
                require(['vs/editor/editor.main'], function () {
                    var resize = function () {
                        console.log("** Resizing **");
                        var height = document.documentElement.clientHeight;
                        var containerDiv = document.getElementById("editor-container");
                        var style = window.getComputedStyle(containerDiv);
                        var hidden = style.display == "none";
                        if (!hidden) {
                            containerDiv.setAttribute("style", "height: " + (height - 200) + "px");
                        }
                    };

                    window.onresize = resize;
                    window.resizeFn = resize;
                    resize();

                    var editor = monaco.editor.create(document.getElementById("editor-container"), {
                        automaticLayout: true,
                        // theme: "vs-dark",
                        fontSize: 16,
                        fontWeight: "bold",
                        scrollBeyondLastLine: false,
                        readOnly: false,
                        value: [
                            '# no data loaded'
                        ].join('\n'),
                        language: 'yaml'
                    });

                    window.appModel = new api_modeller.ViewModel(editor);
                    window.appModel.apply(document.getElementById("the-app"));
                    setTimeout(function() {
                        document.getElementById("preloader").style.display = "none";
                    }, 200);
                });
            };

            loadApp(function(){
                reloadApp();
            });
        });
    })();
</script>
</body>
</html>