<!DOCTYPE html>
<html lang="en">
<head>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta http-equiv="Content-Type" content="text/html;charset=utf-8" >

    <!-- polyfills -->
    <script src="bower_components/webcomponentsjs/webcomponents-lite.min.js"></script>

    <script src="js/preload.js"></script>

    <link rel="stylesheet" href="bower_components/bulma/css/bulma.css">
    <link rel="stylesheet" href="css/app.css">
    <link rel="stylesheet" href="css/validation_styles.css">
    <link rel="stylesheet" href="bower_components/font-awesome/css/font-awesome.min.css">
    <meta charset="UTF-8">
    <title>AMF Validation</title>
</head>
<body>
<!-- Loader view -->
<div id="preloader" class="container is-marginless is-fluid" style="background-color: white; top:0; position: absolute; width: 100%; height: 100%; text-align: center; padding-top: 13%; z-index: 1000">
    <h2 class="title is-2">Loading AMF Validation Tool</h2>
    <progress id="preloader-progress" class="progress is-info" value="0" max="100" style="margin-left: 25%; max-width: 50%">0%</progress>
    <img src="./images/powered_by_mulesoft.png">
</div>

<!-- Main container class -->
<link rel="import" href="validation/nav.html">
<div class="section" style="padding: 0px">
    <div id="the-app" class="container is-marginless is-fluid">
        <div class="columns">
            <div class="column is-2" id="navigator-container">
                <link rel="import" href="validation/navigator.html">
            </div>
            <div class="column">
                <link rel="import" href="validation/editor_shape.html">
            </div>
            <div class="column">
                <link rel="import" href="validation/editor_data.html">
            </div>
        </div>
    </div>
</div>

<script>
    (function() {
        window.global = window;
        // ************
        // $URL will be replaced by the URL passed to the AMF requests
        // to form the final URL for the invocation throught the proxy
        // window.JS_USE_PROXY="https://mycorsproxy.com/$URL";
        // ************
        var loadApp = function(cb) {
            var assets = [
                //"./js/amf_bindings.js",
                "js/amf_playground_validation.js",
                "js/monaco-editor/min/vs/loader.js"
            ];
            var loaded = 0;
            var preload = new createjs.LoadQueue();
            var handleFileComplete = function(event) {
                var oldValue = document.getElementById("preloader-progress").value;
                var newValue = Math.floor(oldValue + (100 / (loaded + assets.length)));
                document.getElementById("preloader-progress").value = newValue;
                document.body.appendChild(event.result);
                loaded++;
                if(assets.length == 0) {
                    document.getElementById("preloader-progress").value = 100;
                    cb();
                } else {
                    console.log("loading " + assets[0]);
                    preload.loadFile(assets.shift());
                }
            };
            preload.addEventListener("fileload", handleFileComplete);
            console.log("loading " + assets[0]);
            preload.loadFile(assets.shift());
        };

        window.addEventListener('WebComponentsReady', function() {
            document.getElementsByName("body");
            // Imported content
            window.reloadApp = function () {
                var importedMap = {};
                var pending = true;
                while (pending === true) {
                    pending = false;
                    var links = document.querySelectorAll('link[rel="import"]');
                    for (var i = 0; i < links.length; i++) {
                        var link = links[i];
                        if (link.import != null && importedMap[link.href] == null) {
                            pending = true;
                            importedMap[link.href] = true;
                            var content = link.import;
                            var el = content.querySelector('.imported');
                            link.parentNode.insertBefore(el.cloneNode(true), link);
                        }
                    }
                }

                require.config({paths: {'vs': 'js/monaco-editor/min/vs'}});
                require(['vs/editor/editor.main'], function () {

                    var resize = function () {
                        console.log("** Resizing **");
                        var height = document.documentElement.clientHeight;
                        var editors = ["editor-data-container", "editor-shape-container"];
                        editors.forEach(function(editor) {
                            var containerDiv = document.getElementById(editor);
                            var style = window.getComputedStyle(containerDiv);
                            var hidden = style.display == "none";
                            if (!hidden) {
                                containerDiv.setAttribute("style", "height: " + (height - 150) + "px");
                            }
                        });

                        var navigatorHeight = getHeight("navigator");
                        var navigatorContainerHeight = getHeight("navigator-container");

                        if(navigatorContainerHeight - navigatorHeight < 154) {
                            document.getElementById("navigator").style.height = (navigatorContainerHeight - 154) + "px";
                        } else {
                            document.getElementById("navigator").style.height = "auto";
                        }

                        document.getElementById("shapes-list").style.height = (height - 200) + "px";
                        document.getElementById("shapes-list").style.overflow = "scroll";

                    };

                    var getHeight = function(containerId) {
                        var containerDiv = document.getElementById(containerId);
                        var containerStyle = window.getComputedStyle(containerDiv);
                        var heightString = containerStyle.height;
                        var heightNumber = heightString.split("px")[0];
                        return Number(heightNumber);
                    };

                    window.onresize = resize;
                    window.resizeFn = resize;
                    resize();

                    var editorData = monaco.editor.create(document.getElementById("editor-data-container"), {
                        automaticLayout: true,
                        // theme: "vs-dark",
                        fontSize: 16,
                        fontWeight: "bold",
                        scrollBeyondLastLine: false,
                        readOnly: false,
                        value: [
                        '{\n  "name": "Timothy",\n  "surname": "Berners-Lee"\n}'
                        ].join('\n'),
                        language: 'json',
                        minimap: {
                            enabled: false
                        }
                    });

                    var editorShape = monaco.editor.create(document.getElementById("editor-shape-container"), {
                        automaticLayout: true,
                        // theme: "vs-dark",
                        fontSize: 16,
                        fontWeight: "bold",
                        scrollBeyondLastLine: false,
                        readOnly: false,
                        value: [
                            "additionalProperties: false\n" +
                            "properties:\n" +
                            "  address:\n" +
                            "    properties:\n" +
                            "      city: string\n" +
                            "      country: string\n" +
                            "      postcode: string\n" +
                            "      street: string\n" +
                            "  age:\n" +
                            "    minimum: 17\n" +
                            "    type: integer\n" +
                            "  scores:\n" +
                            "    items: integer\n" +
                            "    type: array\n" +
                            "    minItems: 3\n" +
                            "    maxItems: 5\n" +
                            "  gender:\n" +
                            "    enum:\n" +
                            "      - female\n" +
                            "      - male\n" +
                            "    type: string\n" +
                            "  name: string\n" +
                            "  surname:\n" +
                            "    required: false\n" +
                            "    type: string"
                        ].join('\n'),
                        language: 'yaml',
                        minimap: {
                            enabled: false
                        }
                    });


                    window.appModel = new amf_playground_validation.ViewModel(editorData,editorShape);
                    window.appModel.apply(document.getElementById("the-app"));
                    setTimeout(function() {
                        document.getElementById("preloader").style.display = "none";
                        var brand = document.getElementById("brand");
                        if (brand) {
                            brand.style.display='block';
                        }
                    }, 200);

                });
            };

            loadApp(function(){
                reloadApp();
            });
        });
    })();
</script>
</body>
</html>