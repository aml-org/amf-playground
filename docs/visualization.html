<!DOCTYPE html>
<html lang="en">

<head>
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=device-dpi, initial-scale=1, maximum-scale=1, user-scalable=yes">
  <meta charset="UTF-8">

  <!-- polyfills -->
  <script src="bower_components/webcomponentsjs/webcomponents-lite.min.js"></script>

  <script src="js/preload.js"></script>
  <script src="js/monaco-editor/monaco-customize.js"></script>

  <link rel="stylesheet" href="bower_components/bulma/css/bulma.css">
  <link rel="stylesheet" href="css/styles.css">
  <link rel="stylesheet" href="bower_components/font-awesome/css/font-awesome.min.css">
  <title>AML Visualization</title>
</head>

<body>
  <!-- Loader view -->
  <div id="preloader" class="container is-marginless is-fluid" style="background-color: white; top:0; position: absolute; width: 100%; height: 100%; text-align: center; padding-top: 13%; z-index: 1000">
    <h2 class="title is-2">Loading AML Visualization Demo</h2>
    <progress id="preloader-progress" class="progress is-info" value="0" max="100" style="margin-left: 25%; max-width: 50%">0%</progress>
  </div>

  <!-- Main container class -->
  <link rel="import" href="html_fragments/visualization/nav.html">
  <div class="section" style="padding: 0px">
    <div id="the-app" class="container is-marginless is-fluid">
      <div class="columns">
        <div class="column">
          <link rel="import" href="html_fragments/visualization/editor.html">
        </div>
        <div class="column">
          <link rel="import" href="html_fragments/visualization/graph.html">
        </div>
      </div>
    </div>
  </div>

  <script>
    (function() {
      window.global = window;
      // ************
      // $URL will be replaced by the URL passed to the AML requests
      // to form the final URL for the invocation throught the proxy
      // window.JS_USE_PROXY="https://mycorsproxy.com/$URL";
      // ************
      var loadApp = function(cb) {
        var assets = [
          "js/aml_playground_visualization.js",
          "js/monaco-editor/min/vs/loader.js"
        ];
        var loaded = 0;
        var preload = new createjs.LoadQueue();
        var handleFileComplete = function(event) {
          var oldValue = document.getElementById("preloader-progress").value;
          var newValue = Math.floor(oldValue + (100 / (loaded + assets.length)));
          document.getElementById("preloader-progress").value = newValue;
          document.body.appendChild(event.result);
          loaded++;
          if (assets.length == 0) {
            document.getElementById("preloader-progress").value = 100;
            cb();
          } else {
            preload.loadFile(assets.shift());
          }
        };
        preload.addEventListener("fileload", handleFileComplete);
        preload.loadFile(assets.shift());
      };

      window.addEventListener('WebComponentsReady', function() {
        document.getElementsByName("body");
        // Imported content
        window.reloadApp = function() {
          var importedMap = {};
          var pending = true;
          while (pending === true) {
            pending = false;
            var links = document.querySelectorAll('link[rel="import"]');
            for (var i = 0; i < links.length; i++) {
              var link = links[i];
              if (link.import != null && importedMap[link.href] == null) {
                pending = true;
                importedMap[link.href] = true;
                var content = link.import;
                var el = content.querySelector('.imported');
                link.parentNode.insertBefore(el.cloneNode(true), link);
              }
            }
          }

          require.config({
            paths: {
              'vs': 'js/monaco-editor/min/vs'
            }
          });
          require(['vs/editor/editor.main'], function() {

            var resize = function() {
              var height = document.documentElement.clientHeight;
              var panes = ["editor-aml", "graph-visual"];
              panes.forEach(function(paneId) {
                var containerDiv = document.getElementById(paneId);
                var style = window.getComputedStyle(containerDiv);
                var hidden = style.display == "none";
                if (!hidden) {
                  containerDiv.setAttribute("style", "height: " + (height - 150) + "px");
                }
              });
            };

            var getHeight = function(containerId) {
              var containerDiv = document.getElementById(containerId);
              var containerStyle = window.getComputedStyle(containerDiv);
              var heightString = containerStyle.height;
              var heightNumber = heightString.split("px")[0];
              return Number(heightNumber);
            };

            window.onresize = resize;
            window.resizeFn = resize;
            resize();

            customizeMonaco();

            var editor = monaco.editor.create(document.getElementById("editor-aml-container"), {
              value: '',
              language: 'aml',
              automaticLayout: true,
              scrollBeyondLastLine: false,
              minimap: {
                enabled: false
              }
            });

            window.appModel = new aml_playground_visualization.ViewModel(editor);
            window.appModel.apply(document.getElementById("the-app"));
            setTimeout(function() {
              document.getElementById("preloader").style.display = "none";
              var brand = document.getElementById("brand");
              if (brand) {
                brand.style.display = 'block';
              }
            }, 200);

          });
        };

        loadApp(function() {
          reloadApp();
        });
      });
    })();
  </script>
</body>

</html>